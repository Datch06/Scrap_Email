{% extends "base.html" %}

{% block title %}Campagnes d'Emails - Scrap Email Manager{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col">
            <h1 class="h2">
                <i class="bi bi-send-fill text-primary"></i>
                Campagnes d'Emails
            </h1>
            <p class="text-muted">Cr√©ez et g√©rez vos campagnes d'envoi d'emails</p>
        </div>
        <div class="col-auto">
            <button class="btn btn-success me-2" data-bs-toggle="modal" data-bs-target="#createTemplateModal">
                <i class="bi bi-file-earmark-plus"></i> Nouveau Template
            </button>
            <button class="btn btn-info me-2" onclick="openTestModalWithSelect()">
                <i class="bi bi-envelope-check"></i> Tester une Campagne
            </button>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createCampaignModal">
                <i class="bi bi-plus-circle"></i> Nouvelle Campagne
            </button>
        </div>
    </div>

    <!-- Liste des campagnes -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-list-ul"></i> Mes Campagnes</h5>
                </div>
                <div class="card-body">
                    <div id="campaigns-list">
                        <div class="text-center py-5">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">Chargement...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Cr√©er un template -->
<div class="modal fade" id="createTemplateModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-file-earmark-plus"></i> Nouveau Template d'Email</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="createTemplateForm">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="mb-3">
                                <label class="form-label">Nom du template *</label>
                                <input type="text" class="form-control" id="template-name" required
                                       placeholder="Ex: Proposition de Backlink Premium">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">Cat√©gorie</label>
                                <select class="form-select" id="template-category">
                                    <option value="prospection">Prospection</option>
                                    <option value="suivi">Suivi</option>
                                    <option value="relance">Relance</option>
                                    <option value="autre">Autre</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" id="template-description" rows="2"
                                  placeholder="Description du template (optionnel)"></textarea>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Sujet de l'email *</label>
                        <input type="text" class="form-control" id="template-subject" required
                               placeholder="Ex: Collaboration SEO avec {{domain}}">
                        <small class="text-muted">Variables disponibles: {{domain}}, {{email}}, {{siret}}, {{leaders}}</small>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Corps HTML de l'email *</label>
                        <textarea class="form-control font-monospace" id="template-html" rows="15" required
                                  placeholder="Bonjour,&#10;&#10;Je souhaite vous proposer une collaboration...&#10;&#10;Cordialement,&#10;Votre nom&#10;&#10;{{unsubscribe_link}}"></textarea>
                        <small class="text-muted">Utilisez les variables: {{domain}}, {{email}}, {{siret}}, {{leaders}}, {{unsubscribe_link}}</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-success" id="btn-create-template">
                    <i class="bi bi-check-circle"></i> Cr√©er le Template
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Cr√©er une campagne -->
<div class="modal fade" id="createCampaignModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-plus-circle"></i> Nouvelle Campagne</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="createCampaignForm">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label class="form-label">Nom de la campagne *</label>
                                <input type="text" class="form-control" id="campaign-name" required>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label class="form-label">Type de campagne *</label>
                                <select class="form-select" id="campaign-type" required>
                                    <option value="normal">Normale</option>
                                    <option value="continuous">Continue</option>
                                </select>
                                <small class="text-muted">Continue = envoie automatiquement aux nouveaux contacts</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label class="form-label">Segment</label>
                                <select class="form-select" id="campaign-segment">
                                    <option value="">Tous les contacts</option>
                                </select>
                                <small class="text-muted">Cibler un segment sp√©cifique</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label class="form-label">Template</label>
                                <select class="form-select" id="campaign-template">
                                    <option value="">Personnalis√©</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" id="campaign-description" rows="2"></textarea>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Sujet de l'email *</label>
                        <input type="text" class="form-control" id="campaign-subject" required
                               placeholder="Ex: Collaboration SEO - {{domain}}">
                        <small class="text-muted">Variables disponibles: {{domain}}, {{email}}, {{siret}}, {{leaders}}</small>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Corps HTML de l'email *</label>
                        <textarea class="form-control font-monospace" id="campaign-html" rows="15" required></textarea>
                        <small class="text-muted">Utilisez {{domain}}, {{email}}, etc. et {{unsubscribe_link}}</small>
                    </div>

                    <hr>

                    <h6>‚öôÔ∏è Options d'envoi</h6>

                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">Score de validation minimum</label>
                                <input type="number" class="form-control" id="campaign-min-score" value="80" min="0" max="100">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">Emails par jour (max)</label>
                                <input type="number" class="form-control" id="campaign-max-per-day" value="200" min="1">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">D√©lai entre emails (s)</label>
                                <input type="number" class="form-control" id="campaign-delay" value="2" min="1">
                            </div>
                        </div>
                    </div>

                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="campaign-deliverable" checked>
                        <label class="form-check-label" for="campaign-deliverable">
                            Envoyer uniquement aux emails d√©livrables (recommand√©)
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-primary" id="btn-create-campaign">
                    <i class="bi bi-check-circle"></i> Cr√©er la Campagne
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal: D√©tails d'une campagne -->
<div class="modal fade" id="campaignDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="campaign-details-title"></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="campaign-details-body">
                <!-- Contenu dynamique -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
                <button type="button" class="btn btn-warning" id="btn-prepare-campaign" style="display:none">
                    <i class="bi bi-gear"></i> Pr√©parer la Campagne
                </button>
                <button type="button" class="btn btn-warning" id="btn-pause-campaign" style="display:none">
                    <i class="bi bi-pause-circle"></i> Mettre en Pause
                </button>
                <button type="button" class="btn btn-info" id="btn-resume-campaign" style="display:none">
                    <i class="bi bi-play-circle"></i> Reprendre
                </button>
                <button type="button" class="btn btn-success" id="btn-send-campaign" style="display:none">
                    <i class="bi bi-send"></i> Lancer l'Envoi
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Tester une campagne -->
<div class="modal fade" id="testCampaignModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-envelope-check"></i> Tester un Email
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Envoyez un email de test pour v√©rifier le rendu et le contenu avant l'envoi massif.</p>
                <p class="text-muted"><small>Le sujet aura le pr√©fixe <strong>[TEST]</strong> et les variables seront remplac√©es par des donn√©es fictives.</small></p>

                <!-- Choix: Campagne ou Template -->
                <div class="mb-3">
                    <label class="form-label">Source du test *</label>
                    <div class="btn-group w-100" role="group">
                        <input type="radio" class="btn-check" name="test-source" id="test-source-campaign" value="campaign" checked>
                        <label class="btn btn-outline-primary" for="test-source-campaign">
                            <i class="bi bi-send"></i> Campagne
                        </label>
                        <input type="radio" class="btn-check" name="test-source" id="test-source-template" value="template">
                        <label class="btn btn-outline-success" for="test-source-template">
                            <i class="bi bi-file-earmark-text"></i> Template
                        </label>
                    </div>
                </div>

                <div class="mb-3" id="campaign-selector-container">
                    <label class="form-label">Campagne √† tester *</label>
                    <select class="form-select" id="test-campaign-select">
                        <option value="">S√©lectionnez une campagne</option>
                    </select>
                </div>

                <div class="mb-3" id="template-selector-container" style="display:none">
                    <label class="form-label">Template √† tester *</label>
                    <select class="form-select" id="test-template-select">
                        <option value="">S√©lectionnez un template</option>
                    </select>
                </div>

                <div class="mb-3">
                    <label class="form-label">Adresses email de test *</label>
                    <textarea
                        class="form-control"
                        id="test-emails"
                        rows="3"
                        placeholder="exemple@gmail.com&#10;autre@example.com&#10;test@test.fr"
                        required></textarea>
                    <small class="text-muted">Une adresse par ligne</small>
                </div>

                <div class="mb-3">
                    <label class="form-label">Domaine de test (optionnel)</label>
                    <input type="text" class="form-control" id="test-domain" placeholder="exemple-test.fr" value="site-test-exemple.fr">
                    <small class="text-muted">Utilis√© pour remplacer la variable {{domain}}</small>
                </div>

                <div id="test-result" class="mt-3" style="display:none"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-info" id="btn-send-test">
                    <i class="bi bi-send"></i> Envoyer le Test
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
let currentCampaignId = null;
let templates = [];

// Charger les templates
async function loadTemplates() {
    try {
        const response = await fetch('/api/templates');
        templates = await response.json();

        const select = document.getElementById('campaign-template');
        templates.forEach(template => {
            const option = document.createElement('option');
            option.value = template.id;
            option.textContent = template.name;
            select.appendChild(option);
        });

        // Event listener pour charger le template
        select.addEventListener('change', function() {
            if (this.value) {
                const template = templates.find(t => t.id == this.value);
                if (template) {
                    document.getElementById('campaign-subject').value = template.subject;
                    document.getElementById('campaign-html').value = template.html_body;
                }
            }
        });
    } catch (error) {
        console.error('Erreur chargement templates:', error);
    }
}

// Charger les segments
async function loadSegments() {
    try {
        const response = await fetch('/api/segments');
        const segments = await response.json();

        const select = document.getElementById('campaign-segment');
        segments.forEach(segment => {
            const option = document.createElement('option');
            option.value = segment.id;
            option.textContent = `${segment.name} (${segment.estimated_count || 0} contacts)`;
            select.appendChild(option);
        });
    } catch (error) {
        console.error('Erreur chargement segments:', error);
    }
}

// Charger les campagnes
async function loadCampaigns() {
    try {
        const response = await fetch('/api/campaigns');
        const data = await response.json();

        const listDiv = document.getElementById('campaigns-list');

        // V√©rifier si data est un tableau ou un objet avec une erreur
        if (!response.ok || data.error) {
            listDiv.innerHTML = `<div class="alert alert-danger">Erreur: ${data.error || 'Impossible de charger les campagnes'}</div>`;
            return;
        }

        const campaigns = Array.isArray(data) ? data : [];

        if (campaigns.length === 0) {
            listDiv.innerHTML = `
                <div class="text-center py-5">
                    <i class="bi bi-inbox" style="font-size: 48px; color: #ccc;"></i>
                    <p class="text-muted mt-3">Aucune campagne cr√©√©e</p>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createCampaignModal">
                        <i class="bi bi-plus-circle"></i> Cr√©er ma premi√®re campagne
                    </button>
                </div>
            `;
            return;
        }

        let html = '<div class="table-responsive"><table class="table table-hover">';
        html += `
            <thead>
                <tr>
                    <th>Nom</th>
                    <th>Type</th>
                    <th>Statut</th>
                    <th>Destinataires</th>
                    <th>Envoy√©s</th>
                    <th>D√©livr√©s</th>
                    <th>Ouverts</th>
                    <th>Cliqu√©s</th>
                    <th>Bounces</th>
                    <th>Plaintes</th>
                    <th>D√©sinscrits</th>
                    <th>Cr√©√©e le</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
        `;

        campaigns.forEach(campaign => {
            const statusBadge = getStatusBadge(campaign.status);
            const typeBadge = getCampaignTypeBadge(campaign.is_continuous);
            const createdDate = new Date(campaign.created_at).toLocaleDateString('fr-FR');

            const unsubscribedCount = campaign.emails_unsubscribed || 0;

            html += `
                <tr>
                    <td>
                        <strong>${campaign.name}</strong>
                        ${campaign.description ? '<br><small class="text-muted">' + campaign.description + '</small>' : ''}
                    </td>
                    <td>${typeBadge}</td>
                    <td>${statusBadge}</td>
                    <td>${campaign.total_recipients}</td>
                    <td>${campaign.emails_sent}</td>
                    <td>${campaign.emails_delivered || 0} <small class="text-muted">(${campaign.emails_sent > 0 ? Math.round(((campaign.emails_delivered || 0) / campaign.emails_sent) * 100) : 0}%)</small></td>
                    <td>${campaign.emails_opened} <small class="text-muted">(${campaign.open_rate}%)</small></td>
                    <td>${campaign.emails_clicked} <small class="text-muted">(${campaign.click_rate}%)</small></td>
                    <td><span class="${(campaign.emails_bounced || 0) > 0 ? 'text-danger' : ''}">${campaign.emails_bounced || 0}</span> <small class="text-muted">(${campaign.bounce_rate}%)</small></td>
                    <td><span class="${(campaign.emails_complained || 0) > 0 ? 'text-warning' : ''}">${campaign.emails_complained || 0}</span></td>
                    <td><span class="${unsubscribedCount > 0 ? 'text-warning' : ''}">${unsubscribedCount}</span></td>
                    <td>${createdDate}</td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="viewCampaign(${campaign.id})">
                            <i class="bi bi-eye"></i> Voir
                        </button>
                        <button class="btn btn-sm btn-info" onclick="testCampaign(${campaign.id}, '${campaign.name}')">
                            <i class="bi bi-envelope-check"></i> Tester
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteCampaign(${campaign.id}, '${campaign.name}')">
                            <i class="bi bi-trash"></i> Supprimer
                        </button>
                    </td>
                </tr>
            `;
        });

        html += '</tbody></table></div>';
        listDiv.innerHTML = html;

    } catch (error) {
        console.error('Erreur chargement campagnes:', error);
        document.getElementById('campaigns-list').innerHTML = `
            <div class="alert alert-danger">
                Erreur lors du chargement des campagnes: ${error.message}
            </div>
        `;
    }
}

function getStatusBadge(status) {
    const badges = {
        'draft': '<span class="badge bg-secondary">Brouillon</span>',
        'scheduled': '<span class="badge bg-info">Planifi√©e</span>',
        'running': '<span class="badge bg-warning">En cours</span>',
        'paused': '<span class="badge bg-warning">En pause</span>',
        'completed': '<span class="badge bg-success">Termin√©e</span>',
        'cancelled': '<span class="badge bg-danger">Annul√©e</span>'
    };
    return badges[status] || status;
}

function getCampaignTypeBadge(isContinuous) {
    if (isContinuous) {
        return '<span class="badge bg-primary" title="Envoie automatiquement aux nouveaux contacts du segment"><i class="bi bi-arrow-repeat"></i> Continue</span>';
    } else {
        return '<span class="badge bg-secondary" title="Envoie uniquement aux contacts du segment au moment de la pr√©paration">Normale</span>';
    }
}

// Cr√©er un template
document.getElementById('btn-create-template').addEventListener('click', async function() {
    const btn = this;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Cr√©ation...';

    try {
        const data = {
            name: document.getElementById('template-name').value,
            description: document.getElementById('template-description').value,
            category: document.getElementById('template-category').value,
            subject: document.getElementById('template-subject').value,
            html_body: document.getElementById('template-html').value
        };

        const response = await fetch('/api/templates', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });

        if (response.ok) {
            const template = await response.json();
            const modal = bootstrap.Modal.getInstance(document.getElementById('createTemplateModal'));
            modal.hide();

            document.getElementById('createTemplateForm').reset();

            alert('‚úÖ Template cr√©√© avec succ√®s!');

            // Recharger les templates pour le select
            loadTemplates();
        } else {
            const error = await response.json();
            alert('‚ùå Erreur: ' + error.error);
        }
    } catch (error) {
        alert('‚ùå Erreur: ' + error.message);
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-check-circle"></i> Cr√©er le Template';
    }
});

// Cr√©er une campagne
document.getElementById('btn-create-campaign').addEventListener('click', async function() {
    const btn = this;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Cr√©ation...';

    try {
        const segmentId = document.getElementById('campaign-segment').value;
        const campaignType = document.getElementById('campaign-type').value;

        const data = {
            name: document.getElementById('campaign-name').value,
            description: document.getElementById('campaign-description').value,
            subject: document.getElementById('campaign-subject').value,
            html_body: document.getElementById('campaign-html').value,
            min_validation_score: parseInt(document.getElementById('campaign-min-score').value),
            only_deliverable: document.getElementById('campaign-deliverable').checked,
            max_emails_per_day: parseInt(document.getElementById('campaign-max-per-day').value),
            delay_between_emails: parseInt(document.getElementById('campaign-delay').value),
            is_continuous: campaignType === 'continuous'
        };

        // Ajouter le segment_id si un segment est s√©lectionn√©
        if (segmentId) {
            data.segment_id = parseInt(segmentId);
        }

        const response = await fetch('/api/campaigns', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });

        if (response.ok) {
            const campaign = await response.json();
            const modal = bootstrap.Modal.getInstance(document.getElementById('createCampaignModal'));
            modal.hide();

            document.getElementById('createCampaignForm').reset();

            alert('‚úÖ Campagne cr√©√©e avec succ√®s!');
            loadCampaigns();
        } else {
            const error = await response.json();
            alert('‚ùå Erreur: ' + error.error);
        }
    } catch (error) {
        alert('‚ùå Erreur: ' + error.message);
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-check-circle"></i> Cr√©er la Campagne';
    }
});

// Voir les d√©tails d'une campagne
async function viewCampaign(campaignId) {
    currentCampaignId = campaignId;

    try {
        const response = await fetch(`/api/campaigns/${campaignId}`);
        const campaign = await response.json();

        document.getElementById('campaign-details-title').textContent = campaign.name;

        let html = `
            <div class="row mb-4">
                <div class="col-md-2">
                    <div class="card">
                        <div class="card-body text-center">
                            <h3>${campaign.total_recipients}</h3>
                            <small class="text-muted">Destinataires</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="card">
                        <div class="card-body text-center">
                            <h3>${campaign.emails_sent}</h3>
                            <small class="text-muted">Envoy√©s</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="card">
                        <div class="card-body text-center">
                            <h3>${campaign.emails_delivered || 0}</h3>
                            <small class="text-muted">D√©livr√©s</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="card">
                        <div class="card-body text-center">
                            <h3>${campaign.open_rate}%</h3>
                            <small class="text-muted">Ouverture</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="card">
                        <div class="card-body text-center">
                            <h3>${campaign.click_rate}%</h3>
                            <small class="text-muted">Clic</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="card border-${(campaign.emails_bounced || 0) > 0 ? 'danger' : 'secondary'}">
                        <div class="card-body text-center">
                            <h3 class="${(campaign.emails_bounced || 0) > 0 ? 'text-danger' : ''}">${campaign.emails_bounced || 0}</h3>
                            <small class="text-muted">Bounces (${campaign.bounce_rate}%)</small>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-md-12">
                    <div class="card border-${(campaign.emails_complained || 0) > 0 ? 'warning' : 'secondary'}">
                        <div class="card-body">
                            <div class="row align-items-center">
                                <div class="col-auto">
                                    <i class="bi bi-exclamation-triangle-fill ${(campaign.emails_complained || 0) > 0 ? 'text-warning' : 'text-muted'}" style="font-size: 2rem;"></i>
                                </div>
                                <div class="col">
                                    <h5 class="mb-0">Plaintes (Spam) : ${campaign.emails_complained || 0}</h5>
                                    <small class="text-muted">Les emails signal√©s comme spam sont automatiquement d√©sinscrits</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <h6>üìß D√©tails de l'email</h6>
            <p><strong>Sujet:</strong> ${campaign.subject}</p>
            <p><strong>De:</strong> ${campaign.from_name} &lt;${campaign.from_email}&gt;</p>

            <h6 class="mt-3">‚öôÔ∏è Configuration</h6>
            <ul>
                <li>Score minimum: ${campaign.min_validation_score}</li>
                <li>Uniquement d√©livrables: ${campaign.only_deliverable ? 'Oui' : 'Non'}</li>
                <li>Max par jour: ${campaign.max_emails_per_day}</li>
            </ul>
        `;

        document.getElementById('campaign-details-body').innerHTML = html;

        // Afficher les boutons appropri√©s
        const btnPrepare = document.getElementById('btn-prepare-campaign');
        const btnSend = document.getElementById('btn-send-campaign');
        const btnPause = document.getElementById('btn-pause-campaign');
        const btnResume = document.getElementById('btn-resume-campaign');

        // Cacher tous les boutons d'action par d√©faut
        btnPrepare.style.display = 'none';
        btnSend.style.display = 'none';
        btnPause.style.display = 'none';
        btnResume.style.display = 'none';

        // Afficher selon le statut
        if (campaign.status === 'draft') {
            btnPrepare.style.display = 'inline-block';
        } else if (campaign.status === 'scheduled') {
            btnSend.style.display = 'inline-block';
        } else if (campaign.status === 'running') {
            btnPause.style.display = 'inline-block';
        } else if (campaign.status === 'paused') {
            btnResume.style.display = 'inline-block';
        }

        const modal = new bootstrap.Modal(document.getElementById('campaignDetailsModal'));
        modal.show();

    } catch (error) {
        alert('Erreur: ' + error.message);
    }
}

// Pr√©parer la campagne
document.getElementById('btn-prepare-campaign').addEventListener('click', async function() {
    if (!currentCampaignId) return;

    if (!confirm('Pr√©parer cette campagne? Cela va s√©lectionner les destinataires √©ligibles.')) return;

    const btn = this;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Pr√©paration...';

    try {
        const response = await fetch(`/api/campaigns/${currentCampaignId}/prepare`, {
            method: 'POST'
        });

        if (response.ok) {
            const result = await response.json();
            alert(`‚úÖ Campagne pr√©par√©e!\n${result.total_recipients} destinataires s√©lectionn√©s.`);
            viewCampaign(currentCampaignId);
            loadCampaigns();
        } else {
            const error = await response.json();
            alert('‚ùå Erreur: ' + error.error);
        }
    } catch (error) {
        alert('‚ùå Erreur: ' + error.message);
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-gear"></i> Pr√©parer la Campagne';
    }
});

// Lancer l'envoi
document.getElementById('btn-send-campaign').addEventListener('click', async function() {
    if (!currentCampaignId) return;

    const limit = prompt('Combien d\'emails envoyer? (Vide = tous)', '100');
    if (limit === null) return;

    const btn = this;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Envoi...';

    try {
        const response = await fetch(`/api/campaigns/${currentCampaignId}/send`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ limit: limit ? parseInt(limit) : null })
        });

        if (response.ok) {
            const result = await response.json();
            alert('‚úÖ ' + result.message + '\nLes statistiques seront mises √† jour progressivement.');

            // Actualiser toutes les 5 secondes
            const interval = setInterval(() => {
                viewCampaign(currentCampaignId);
                loadCampaigns();
            }, 5000);

            // Arr√™ter apr√®s 2 minutes
            setTimeout(() => clearInterval(interval), 120000);
        } else {
            const error = await response.json();
            alert('‚ùå Erreur: ' + error.error);
        }
    } catch (error) {
        alert('‚ùå Erreur: ' + error.message);
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-send"></i> Lancer l\'Envoi';
    }
});

// Mettre en pause une campagne
document.getElementById('btn-pause-campaign').addEventListener('click', async function() {
    if (!currentCampaignId) return;

    if (!confirm('Mettre en pause cette campagne? L\'envoi des emails sera interrompu imm√©diatement.')) return;

    const btn = this;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Pause...';

    try {
        const response = await fetch(`/api/campaigns/${currentCampaignId}/pause`, {
            method: 'POST'
        });

        if (response.ok) {
            const result = await response.json();
            alert('‚è∏Ô∏è ' + result.message);

            // Rafra√Æchir la vue
            viewCampaign(currentCampaignId);
            loadCampaigns();
        } else {
            const error = await response.json();
            alert('‚ùå Erreur: ' + error.error);
        }
    } catch (error) {
        alert('‚ùå Erreur: ' + error.message);
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-pause-circle"></i> Mettre en Pause';
    }
});

// Reprendre une campagne en pause
document.getElementById('btn-resume-campaign').addEventListener('click', async function() {
    if (!currentCampaignId) return;

    if (!confirm('Reprendre cette campagne? L\'envoi des emails va continuer.')) return;

    const btn = this;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Reprise...';

    try {
        const response = await fetch(`/api/campaigns/${currentCampaignId}/resume`, {
            method: 'POST'
        });

        if (response.ok) {
            const result = await response.json();
            alert('‚ñ∂Ô∏è ' + result.message);

            // Rafra√Æchir la vue et actualiser automatiquement
            viewCampaign(currentCampaignId);
            loadCampaigns();

            // Actualiser toutes les 5 secondes pendant la reprise
            const interval = setInterval(() => {
                viewCampaign(currentCampaignId);
                loadCampaigns();
            }, 5000);

            // Arr√™ter apr√®s 2 minutes
            setTimeout(() => clearInterval(interval), 120000);
        } else {
            const error = await response.json();
            alert('‚ùå Erreur: ' + error.error);
        }
    } catch (error) {
        alert('‚ùå Erreur: ' + error.message);
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-play-circle"></i> Reprendre';
    }
});

// Tester une campagne
let currentTestCampaignId = null;
let currentTestCampaignName = null;
let allCampaigns = [];

// Basculer entre campagne et template
document.querySelectorAll('input[name="test-source"]').forEach(radio => {
    radio.addEventListener('change', function() {
        const campaignContainer = document.getElementById('campaign-selector-container');
        const templateContainer = document.getElementById('template-selector-container');

        if (this.value === 'campaign') {
            campaignContainer.style.display = 'block';
            templateContainer.style.display = 'none';
        } else {
            campaignContainer.style.display = 'none';
            templateContainer.style.display = 'block';
        }
    });
});

// Ouvrir le modal avec s√©lecteur de campagne
async function openTestModalWithSelect() {
    // Charger les campagnes si pas encore charg√©
    if (allCampaigns.length === 0) {
        try {
            const response = await fetch('/api/campaigns');
            allCampaigns = await response.json();
        } catch (error) {
            alert('‚ùå Erreur lors du chargement des campagnes: ' + error.message);
            return;
        }
    }

    // Remplir le s√©lecteur de campagnes
    const campaignSelect = document.getElementById('test-campaign-select');
    campaignSelect.innerHTML = '<option value="">S√©lectionnez une campagne</option>';
    allCampaigns.forEach(campaign => {
        const option = document.createElement('option');
        option.value = campaign.id;
        option.textContent = `${campaign.name} (${campaign.status})`;
        campaignSelect.appendChild(option);
    });

    // Remplir le s√©lecteur de templates
    const templateSelect = document.getElementById('test-template-select');
    templateSelect.innerHTML = '<option value="">S√©lectionnez un template</option>';
    templates.forEach(template => {
        const option = document.createElement('option');
        option.value = template.id;
        option.textContent = `${template.name} (${template.category})`;
        templateSelect.appendChild(option);
    });

    // R√©initialiser le formulaire
    document.getElementById('test-source-campaign').checked = true;
    document.getElementById('campaign-selector-container').style.display = 'block';
    document.getElementById('template-selector-container').style.display = 'none';
    document.getElementById('test-emails').value = '';
    document.getElementById('test-domain').value = 'site-test-exemple.fr';
    document.getElementById('test-result').style.display = 'none';
    currentTestCampaignId = null;

    // Afficher le modal
    const modal = new bootstrap.Modal(document.getElementById('testCampaignModal'));
    modal.show();
}

// Ouvrir le modal depuis le tableau (campagne d√©j√† s√©lectionn√©e)
function testCampaign(campaignId, campaignName) {
    currentTestCampaignId = campaignId;
    currentTestCampaignName = campaignName;

    // Cacher le s√©lecteur, r√©initialiser le formulaire
    document.getElementById('campaign-selector-container').style.display = 'none';
    document.getElementById('test-emails').value = '';
    document.getElementById('test-domain').value = 'site-test-exemple.fr';
    document.getElementById('test-result').style.display = 'none';

    // Afficher le modal
    const modal = new bootstrap.Modal(document.getElementById('testCampaignModal'));
    modal.show();
}

// Supprimer une campagne
async function deleteCampaign(campaignId, campaignName) {
    if (!confirm(`√ätes-vous s√ªr de vouloir supprimer la campagne "${campaignName}" ?\n\nCette action est irr√©versible et supprimera √©galement tous les emails associ√©s.`)) {
        return;
    }

    try {
        const response = await fetch(`/api/campaigns/${campaignId}`, {
            method: 'DELETE'
        });

        const result = await response.json();

        if (response.ok) {
            alert(`‚úÖ ${result.message}`);
            // Recharger la liste des campagnes
            loadCampaigns();
        } else {
            alert(`‚ùå Erreur: ${result.error}`);
        }
    } catch (error) {
        console.error('Erreur lors de la suppression:', error);
        alert(`‚ùå Erreur lors de la suppression: ${error.message}`);
    }
}

document.getElementById('btn-send-test').addEventListener('click', async function() {
    // D√©terminer la source (campagne ou template)
    const testSource = document.querySelector('input[name="test-source"]:checked').value;
    let testId = null;
    let apiUrl = null;
    let sourceName = '';

    if (testSource === 'campaign') {
        // Si le s√©lecteur est visible, r√©cup√©rer l'ID depuis le select
        const selectorContainer = document.getElementById('campaign-selector-container');
        if (selectorContainer.style.display !== 'none') {
            const selectValue = document.getElementById('test-campaign-select').value;
            if (!selectValue) {
                alert('‚ö†Ô∏è Veuillez s√©lectionner une campagne √† tester');
                return;
            }
            testId = parseInt(selectValue);
        } else {
            testId = currentTestCampaignId;
        }

        if (!testId) {
            alert('‚ö†Ô∏è Aucune campagne s√©lectionn√©e');
            return;
        }

        apiUrl = `/api/campaigns/${testId}/test`;
        sourceName = 'campagne';
    } else {
        // Template
        const selectValue = document.getElementById('test-template-select').value;
        if (!selectValue) {
            alert('‚ö†Ô∏è Veuillez s√©lectionner un template √† tester');
            return;
        }
        testId = parseInt(selectValue);
        apiUrl = `/api/templates/${testId}/test`;
        sourceName = 'template';
    }

    const emailsText = document.getElementById('test-emails').value.trim();
    if (!emailsText) {
        alert('‚ö†Ô∏è Veuillez entrer au moins une adresse email');
        return;
    }

    // S√©parer les emails (par ligne, virgule ou point-virgule)
    const testEmails = emailsText
        .split(/[\n,;]+/)
        .map(e => e.trim())
        .filter(e => e.length > 0);

    if (testEmails.length === 0) {
        alert('‚ö†Ô∏è Aucune adresse email valide trouv√©e');
        return;
    }

    const testDomain = document.getElementById('test-domain').value.trim() || 'site-test-exemple.fr';

    const btn = this;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Envoi...';

    try {
        const response = await fetch(apiUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                test_emails: testEmails,
                test_domain: testDomain
            })
        });

        const result = await response.json();

        if (response.ok) {
            // Afficher les r√©sultats
            let html = '<div class="alert alert-success">';
            html += `<h6><i class="bi bi-check-circle"></i> Test envoy√© avec succ√®s!</h6>`;
            html += `<p><strong>${sourceName === 'template' ? 'Template' : 'Campagne'}:</strong> ${result.campaign_name || result.template_name}</p>`;
            html += `<p><strong>Envoy√©s:</strong> ${result.total_sent} / ${testEmails.length}</p>`;

            if (result.sent.length > 0) {
                html += '<p><strong>‚úÖ Succ√®s:</strong></p><ul class="mb-0">';
                result.sent.forEach(email => {
                    html += `<li>${email}</li>`;
                });
                html += '</ul>';
            }

            if (result.failed.length > 0) {
                html += '<p class="mt-2"><strong>‚ùå √âchecs:</strong></p><ul class="mb-0">';
                result.failed.forEach(item => {
                    if (typeof item === 'object') {
                        html += `<li>${item.email}: ${item.error}</li>`;
                    } else {
                        html += `<li>${item}</li>`;
                    }
                });
                html += '</ul>';
            }

            html += '<p class="mt-3 mb-0"><small class="text-muted">V√©rifiez votre bo√Æte de r√©ception (incluant spam/promotions). Le sujet commence par <strong>[TEST]</strong>.</small></p>';
            html += '</div>';

            document.getElementById('test-result').innerHTML = html;
            document.getElementById('test-result').style.display = 'block';

            // Vider les champs si tout est r√©ussi
            if (result.total_failed === 0) {
                setTimeout(() => {
                    document.getElementById('test-emails').value = '';
                }, 2000);
            }
        } else {
            // Erreur
            let html = '<div class="alert alert-danger">';
            html += `<strong>‚ùå Erreur:</strong> ${result.error || 'Erreur inconnue'}`;
            html += '</div>';

            document.getElementById('test-result').innerHTML = html;
            document.getElementById('test-result').style.display = 'block';
        }
    } catch (error) {
        let html = '<div class="alert alert-danger">';
        html += `<strong>‚ùå Erreur:</strong> ${error.message}`;
        html += '</div>';

        document.getElementById('test-result').innerHTML = html;
        document.getElementById('test-result').style.display = 'block';
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-send"></i> Envoyer le Test';
    }
});

// Initialisation
loadTemplates();
loadSegments();
loadCampaigns();

// Actualiser toutes les 30 secondes
setInterval(loadCampaigns, 30000);
</script>
{% endblock %}

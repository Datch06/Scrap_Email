{% extends "base.html" %}

{% block title %}Sites - Scrap Email Manager{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <h1 class="display-5"><i class="bi bi-globe"></i> Gestion des Sites</h1>
        <p class="text-muted">Liste compl√®te de tous les sites d√©couverts</p>
    </div>
</div>

<!-- Filtres et recherche -->
<div class="card mb-4">
    <div class="card-body">
        <div class="row g-3">
            <div class="col-md-2">
                <label class="form-label">Domaine</label>
                <input type="text" class="form-control" id="search-input" placeholder="Domaine...">
            </div>
            <div class="col-md-2">
                <label class="form-label">Email</label>
                <input type="text" class="form-control" id="email-search-input" placeholder="Email...">
            </div>
            <div class="col-md-2">
                <label class="form-label">Statut</label>
                <select class="form-select" id="status-filter">
                    <option value="">Tous</option>
                    <option value="discovered">D√©couvert</option>
                    <option value="email_found">Email trouv√©</option>
                    <option value="email_not_found">Email non trouv√©</option>
                    <option value="siret_found">SIRET trouv√©</option>
                    <option value="siret_not_found">SIRET non trouv√©</option>
                    <option value="leaders_found">Dirigeants trouv√©s</option>
                    <option value="completed">Complet</option>
                    <option value="error">Erreur</option>
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">Email</label>
                <select class="form-select" id="email-filter">
                    <option value="">Tous</option>
                    <option value="true">Avec email</option>
                    <option value="false">Sans email</option>
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">SIRET</label>
                <select class="form-select" id="siret-filter">
                    <option value="">Tous</option>
                    <option value="true">Avec SIRET</option>
                    <option value="false">Sans SIRET</option>
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">Dirigeants</label>
                <select class="form-select" id="leaders-filter">
                    <option value="">Tous</option>
                    <option value="true">Avec dirigeants</option>
                    <option value="false">Sans dirigeants</option>
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">CMS</label>
                <select class="form-select" id="cms-filter">
                    <option value="">Tous</option>
                    <option value="WordPress">WordPress</option>
                    <option value="WooCommerce">WooCommerce</option>
                    <option value="Drupal">Drupal</option>
                    <option value="PrestaShop">PrestaShop</option>
                    <option value="Shopify">Shopify</option>
                    <option value="Joomla">Joomla</option>
                    <option value="Magento">Magento</option>
                    <option value="no_cms">Sans CMS d√©tect√©</option>
                </select>
            </div>
        </div>
        <div class="mt-3">
            <button class="btn btn-primary" onclick="applyFilters()">
                <i class="bi bi-funnel"></i> Appliquer
            </button>
            <button class="btn btn-secondary" onclick="resetFilters()">
                <i class="bi bi-x-circle"></i> R√©initialiser
            </button>
        </div>
    </div>
</div>

<!-- Tableau des sites -->
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Sites (<span id="total-count">0</span>)</h5>
        <div>
            <button class="btn btn-sm btn-success" onclick="showAddModal()">
                <i class="bi bi-plus-circle"></i> Ajouter
            </button>
        </div>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Domaine</th>
                        <th>Statut</th>
                        <th>Email</th>
                        <th>SIRET</th>
                        <th>Dirigeants</th>
                        <th>Langue</th>
                        <th>Email trouv√© le</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="sites-table-body">
                    <tr>
                        <td colspan="8" class="text-center">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">Chargement...</span>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        <nav>
            <ul class="pagination justify-content-center" id="pagination">
            </ul>
        </nav>
    </div>
</div>

<!-- Modal Ajout Site -->
<div class="modal fade" id="addSiteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Ajouter un site</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Domaine *</label>
                    <input type="text" class="form-control" id="new-domain" placeholder="example.fr">
                </div>
                <div class="mb-3">
                    <label class="form-label">Source URL</label>
                    <input type="text" class="form-control" id="new-source" placeholder="https://...">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-primary" onclick="addSite()">Ajouter</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal D√©tails Site -->
<div class="modal fade" id="siteDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">D√©tails du site</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="site-details-content">
                <!-- Contenu charg√© dynamiquement -->
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentPage = 1;
let currentFilters = {};

// Charger les sites
async function loadSites(page = 1) {
    currentPage = page;

    const params = new URLSearchParams({
        page: page,
        per_page: 50,
        ...currentFilters
    });

    try {
        const response = await fetch(`/api/sites?${params}`);
        const data = await response.json();

        renderSitesTable(data.sites);
        renderPagination(data.page, data.total_pages);
        document.getElementById('total-count').textContent = data.total;

    } catch (error) {
        console.error('Erreur:', error);
        document.getElementById('sites-table-body').innerHTML = `
            <tr><td colspan="8" class="text-center text-danger">Erreur de chargement</td></tr>
        `;
    }
}

// Afficher les sites dans le tableau
function renderSitesTable(sites) {
    const tbody = document.getElementById('sites-table-body');

    if (sites.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="text-center">Aucun site trouv√©</td></tr>';
        return;
    }

    tbody.innerHTML = sites.map(site => `
        <tr>
            <td>
                <a href="https://${site.domain}" target="_blank">
                    <i class="bi bi-box-arrow-up-right"></i> ${site.domain}
                </a>
            </td>
            <td>${getStatusBadge(site.status)}</td>
            <td>${site.emails ? '<i class="bi bi-check-circle text-success"></i>' : '<i class="bi bi-x-circle text-muted"></i>'}</td>
            <td>${site.siret ? '<i class="bi bi-check-circle text-success"></i>' : '<i class="bi bi-x-circle text-muted"></i>'}</td>
            <td>${site.leaders ? '<i class="bi bi-check-circle text-success"></i>' : '<i class="bi bi-x-circle text-muted"></i>'}</td>
            <td>${site.language ? `<span class="badge bg-info">${site.language.toUpperCase()}</span>` : '<span class="text-muted">-</span>'}</td>
            <td>${site.email_found_at ? new Date(site.email_found_at).toLocaleString('fr-FR') : (site.updated_at ? new Date(site.updated_at).toLocaleString('fr-FR') : '-')}</td>
            <td>
                <button class="btn btn-sm btn-info" onclick="viewSite(${site.id})">
                    <i class="bi bi-eye"></i>
                </button>
                <button class="btn btn-sm ${site.is_active ? 'btn-warning' : 'btn-success'}"
                        onclick="toggleSiteActive(${site.id}, ${site.is_active})"
                        title="${site.is_active ? 'D√©sactiver ce site' : 'Activer ce site'}">
                    <i class="bi bi-${site.is_active ? 'pause-circle' : 'play-circle'}"></i>
                </button>
                <button class="btn btn-sm btn-danger" onclick="deleteSite(${site.id})" title="Supprimer d√©finitivement">
                    <i class="bi bi-trash"></i>
                </button>
            </td>
        </tr>
    `).join('');
}

// Badge de statut
function getStatusBadge(status) {
    const badges = {
        'discovered': '<span class="badge bg-secondary">D√©couvert</span>',
        'email_found': '<span class="badge bg-success">Email trouv√©</span>',
        'email_not_found': '<span class="badge bg-warning">Email non trouv√©</span>',
        'siret_found': '<span class="badge bg-info">SIRET trouv√©</span>',
        'siret_not_found': '<span class="badge bg-warning">SIRET non trouv√©</span>',
        'leaders_found': '<span class="badge bg-primary">Dirigeants trouv√©s</span>',
        'completed': '<span class="badge bg-success">Complet</span>',
        'error': '<span class="badge bg-danger">Erreur</span>',
    };
    return badges[status] || '<span class="badge bg-secondary">-</span>';
}

// Pagination
function renderPagination(current, total) {
    const pagination = document.getElementById('pagination');
    let html = '';

    if (current > 1) {
        html += `<li class="page-item"><a class="page-link" href="#" onclick="loadSites(${current - 1}); return false;">Pr√©c√©dent</a></li>`;
    }

    const start = Math.max(1, current - 2);
    const end = Math.min(total, current + 2);

    for (let i = start; i <= end; i++) {
        html += `<li class="page-item ${i === current ? 'active' : ''}">
            <a class="page-link" href="#" onclick="loadSites(${i}); return false;">${i}</a>
        </li>`;
    }

    if (current < total) {
        html += `<li class="page-item"><a class="page-link" href="#" onclick="loadSites(${current + 1}); return false;">Suivant</a></li>`;
    }

    pagination.innerHTML = html;
}

// Appliquer les filtres
function applyFilters() {
    currentFilters = {
        search: document.getElementById('search-input').value,
        email_search: document.getElementById('email-search-input').value,
        status: document.getElementById('status-filter').value,
        has_email: document.getElementById('email-filter').value,
        has_siret: document.getElementById('siret-filter').value,
        has_leaders: document.getElementById('leaders-filter').value,
        cms: document.getElementById('cms-filter').value,
    };
    loadSites(1);
}

// R√©initialiser les filtres
function resetFilters() {
    document.getElementById('search-input').value = '';
    document.getElementById('email-search-input').value = '';
    document.getElementById('status-filter').value = '';
    document.getElementById('email-filter').value = '';
    document.getElementById('siret-filter').value = '';
    document.getElementById('leaders-filter').value = '';
    document.getElementById('cms-filter').value = '';
    currentFilters = {};
    loadSites(1);
}

// Afficher modal ajout
function showAddModal() {
    const modal = new bootstrap.Modal(document.getElementById('addSiteModal'));
    modal.show();
}

// Ajouter un site
async function addSite() {
    const domain = document.getElementById('new-domain').value.trim();
    const source = document.getElementById('new-source').value.trim();

    if (!domain) {
        alert('Le domaine est requis');
        return;
    }

    try {
        const response = await fetch('/api/sites', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({domain, source_url: source})
        });

        if (response.ok) {
            bootstrap.Modal.getInstance(document.getElementById('addSiteModal')).hide();
            document.getElementById('new-domain').value = '';
            document.getElementById('new-source').value = '';
            loadSites(currentPage);
        } else {
            const error = await response.json();
            alert(error.error || 'Erreur lors de l\'ajout');
        }
    } catch (error) {
        console.error('Erreur:', error);
        alert('Erreur lors de l\'ajout du site');
    }
}

// Voir d√©tails
async function viewSite(id) {
    try {
        const response = await fetch(`/api/sites/${id}`);
        const site = await response.json();

        const content = `
            <table class="table">
                <tr><th>Domaine</th><td><a href="https://${site.domain}" target="_blank">${site.domain}</a></td></tr>
                <tr><th>Statut</th><td>${getStatusBadge(site.status)}</td></tr>
                ${site.cms ? `<tr><th>CMS</th><td><span class="badge bg-primary">${site.cms}</span> ${site.cms_version ? `<span class="badge bg-secondary">v${site.cms_version}</span>` : ''}</td></tr>` : ''}
                ${site.language ? `<tr><th>üåç Langue</th><td><span class="badge bg-info">${site.language.toUpperCase()}</span> ${site.language_confidence ? `<small class="text-muted">(${Math.round(site.language_confidence * 100)}% confiance)</small>` : ''}</td></tr>` : ''}
                <tr><th>Emails</th><td><div id="emails-container" data-emails="${site.emails ? site.emails.replace(/"/g, '&quot;') : ''}"><i class="spinner-border spinner-border-sm"></i> Chargement...</div></td></tr>
                <tr><th>SIRET</th><td>${site.siret || '-'}</td></tr>
                <tr><th>SIREN</th><td>${site.siren || '-'}</td></tr>
                <tr><th>Dirigeants</th><td>${site.leaders || '-'}</td></tr>
                ${site.purchased_from || site.source_url ? `
                <tr>
                    <th colspan="2" class="table-secondary"><i class="bi bi-link-45deg"></i> Source du backlink</th>
                </tr>
                ${site.purchased_from ? `<tr><th>Site vendeur</th><td><a href="https://${site.purchased_from}" target="_blank"><i class="bi bi-shop"></i> ${site.purchased_from}</a></td></tr>` : ''}
                ${site.source_url ? `<tr><th>Page source</th><td><a href="${site.source_url.startsWith('http') ? site.source_url : 'https://' + site.source_url}" target="_blank" style="word-break: break-all;"><i class="bi bi-box-arrow-up-right"></i> ${site.source_url.length > 80 ? site.source_url.substring(0, 80) + '...' : site.source_url}</a></td></tr>` : ''}
                ` : ''}
                ${site.backlinks_crawled ? `
                <tr>
                    <th colspan="2" class="table-secondary"><i class="bi bi-search"></i> Statistiques de crawl</th>
                </tr>
                <tr><th>üìÑ Pages crawl√©es</th><td><strong>${site.pages_crawled || 0}</strong></td></tr>
                <tr><th>üó∫Ô∏è URLs sitemap</th><td>${site.sitemap_urls_count || 0}</td></tr>
                ${site.sitemap_urls_count > 0 ? `<tr><th>üìä Couverture</th><td>${Math.min(100, Math.round((site.pages_crawled / site.sitemap_urls_count) * 100))}% ${site.sitemap_missed_interesting > 0 ? `<span class="badge bg-warning">${site.sitemap_missed_interesting} URLs int√©ressantes manqu√©es</span>` : '<span class="badge bg-success">OK</span>'}</td></tr>` : ''}
                <tr><th>üìÖ Crawl√© le</th><td>${site.backlinks_crawled_at ? new Date(site.backlinks_crawled_at).toLocaleString('fr-FR') : '-'}</td></tr>
                ` : ''}
                <tr><th>Cr√©√© le</th><td>${new Date(site.created_at).toLocaleString('fr-FR')}</td></tr>
                <tr><th>Mis √† jour le</th><td>${new Date(site.updated_at).toLocaleString('fr-FR')}</td></tr>
                ${site.last_error ? `<tr><th>Erreur</th><td class="text-danger">${site.last_error}</td></tr>` : ''}
            </table>
        `;

        document.getElementById('site-details-content').innerHTML = content;
        const modal = new bootstrap.Modal(document.getElementById('siteDetailsModal'));
        modal.show();

        // Charger les emails de mani√®re async (apr√®s affichage du modal)
        if (site.emails) {
            await formatEmailsWithUnsubscribe(site.emails, 'emails-container');
        } else {
            document.getElementById('emails-container').innerHTML = '-';
        }

    } catch (error) {
        console.error('Erreur:', error);
    }
}

// Activer/D√©sactiver un site
async function toggleSiteActive(id, currentStatus) {
    const action = currentStatus ? 'd√©sactiver' : 'activer';
    if (!confirm(`Voulez-vous vraiment ${action} ce site ?\n\n${currentStatus ? '‚ö†Ô∏è Le site sera exclu des campagnes d\'emailing.' : '‚úÖ Le site pourra √† nouveau recevoir des emails de campagne.'}`)) return;

    try {
        const response = await fetch(`/api/sites/${id}/toggle-active`, {method: 'POST'});
        if (response.ok) {
            const data = await response.json();
            const statusText = data.is_active ? 'activ√©' : 'd√©sactiv√©';
            alert(`‚úÖ Site ${statusText} avec succ√®s`);
            loadSites(currentPage);
        }
    } catch (error) {
        console.error('Erreur:', error);
        alert('‚ùå Erreur lors du changement de statut');
    }
}

// Formater les emails avec boutons de d√©sabonnement individuels (async pour v√©rifier statut)
async function formatEmailsWithUnsubscribe(emailsStr, containerId) {
    const emails = emailsStr.split(/[;,]/).map(e => e.trim()).filter(e => e);

    if (emails.length === 0) {
        document.getElementById(containerId).innerHTML = '-';
        return;
    }

    // V√©rifier quels emails sont d√©sabonn√©s
    let unsubscribedList = [];
    try {
        const response = await fetch('/api/check-unsubscribed', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({emails: emails})
        });
        const data = await response.json();
        unsubscribedList = data.unsubscribed || [];
    } catch (e) {
        console.error('Erreur v√©rification d√©sabonnements:', e);
    }

    let html = '<div class="d-flex flex-column gap-1">';

    // Chaque email avec son bouton
    emails.forEach(email => {
        const isUnsubscribed = unsubscribedList.includes(email.toLowerCase());
        if (isUnsubscribed) {
            html += `
                <div class="d-flex align-items-center gap-2" id="email-row-${email.replace(/[^a-z0-9]/gi, '_')}">
                    <span style="text-decoration: line-through; color: #999;">${email}</span>
                    <span class="badge bg-secondary">D√©sabonn√©</span>
                    <button class="btn btn-sm btn-outline-success py-0 px-1" onclick="resubscribeEmail('${email.replace(/'/g, "\\'")}')">
                        <i class="bi bi-arrow-counterclockwise"></i>
                    </button>
                </div>
            `;
        } else {
            html += `
                <div class="d-flex align-items-center gap-2" id="email-row-${email.replace(/[^a-z0-9]/gi, '_')}">
                    <span>${email}</span>
                    <button class="btn btn-sm btn-outline-danger py-0 px-1" onclick="unsubscribeEmail('${email.replace(/'/g, "\\'")}')">
                        <i class="bi bi-x"></i>
                    </button>
                </div>
            `;
        }
    });

    // Bouton pour d√©sabonner tous si plusieurs emails actifs
    const activeEmails = emails.filter(e => !unsubscribedList.includes(e.toLowerCase()));
    if (activeEmails.length > 1) {
        html += `
            <div class="mt-2">
                <button class="btn btn-sm btn-danger" onclick="unsubscribeEmails('${activeEmails.join(';').replace(/'/g, "\\'")}')">
                    <i class="bi bi-envelope-x"></i> D√©sabonner tous (${activeEmails.length})
                </button>
            </div>
        `;
    }

    html += '</div>';
    document.getElementById(containerId).innerHTML = html;
}

// D√©sabonner un seul email
async function unsubscribeEmail(email) {
    if (!confirm(`‚ö†Ô∏è D√©sabonner cet email ?\n\n${email}\n\nIl ne recevra plus aucun email de campagne.`)) return;

    try {
        const response = await fetch('/api/unsubscribe', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({email: email})
        });
        const data = await response.json();
        if (data.success) {
            alert(`‚úÖ ${email} d√©sabonn√© avec succ√®s`);
            // Rafra√Æchir le modal si ouvert
            const emailContainer = document.getElementById('emails-container');
            if (emailContainer && emailContainer.dataset.emails) {
                await formatEmailsWithUnsubscribe(emailContainer.dataset.emails, 'emails-container');
            }
        } else {
            alert(`‚ùå Erreur: ${data.error}`);
        }
    } catch (error) {
        alert(`‚ùå Erreur: ${error.message}`);
    }
}

// D√©sabonner plusieurs emails d'un site
async function unsubscribeEmails(emailsStr) {
    // S√©parer les emails (peuvent √™tre s√©par√©s par ; ou ,)
    const emails = emailsStr.split(/[;,]/).map(e => e.trim()).filter(e => e);

    if (emails.length === 0) {
        alert('Aucun email √† d√©sabonner');
        return;
    }

    const emailList = emails.join('\n  - ');
    if (!confirm(`‚ö†Ô∏è D√©sabonner ces emails ?\n\n  - ${emailList}\n\nIls ne recevront plus aucun email de campagne.`)) return;

    let success = 0;
    let errors = [];

    for (const email of emails) {
        try {
            const response = await fetch('/api/unsubscribe', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({email: email})
            });
            const data = await response.json();
            if (data.success) {
                success++;
            } else {
                errors.push(`${email}: ${data.error}`);
            }
        } catch (error) {
            errors.push(`${email}: ${error.message}`);
        }
    }

    if (success > 0) {
        alert(`‚úÖ ${success} email(s) d√©sabonn√©(s) avec succ√®s`);
    }
    if (errors.length > 0) {
        alert(`‚ùå Erreurs:\n${errors.join('\n')}`);
    }
}

// R√©activer un email d√©sabonn√©
async function resubscribeEmail(email) {
    if (!confirm(`üîÑ R√©activer cet email ?\n\n${email}\n\nIl pourra √† nouveau recevoir des emails de campagne.`)) return;

    try {
        const response = await fetch('/api/resubscribe', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({email: email})
        });
        const data = await response.json();
        if (data.success) {
            alert(`‚úÖ ${email} r√©activ√© avec succ√®s`);
            // Rafra√Æchir le modal si ouvert
            const emailContainer = document.getElementById('emails-container');
            if (emailContainer && emailContainer.dataset.emails) {
                await formatEmailsWithUnsubscribe(emailContainer.dataset.emails, 'emails-container');
            }
        } else {
            alert(`‚ùå Erreur: ${data.error}`);
        }
    } catch (error) {
        alert(`‚ùå Erreur: ${error.message}`);
    }
}

// Supprimer un site
async function deleteSite(id) {
    if (!confirm('‚ö†Ô∏è ATTENTION : Voulez-vous vraiment SUPPRIMER D√âFINITIVEMENT ce site ?\n\nCette action est IRR√âVERSIBLE.\nToutes les donn√©es seront perdues.\n\nPour simplement exclure un site des campagnes, utilisez plut√¥t le bouton D√©sactiver.')) return;

    try {
        const response = await fetch(`/api/sites/${id}`, {method: 'DELETE'});
        if (response.ok) {
            alert('‚úÖ Site supprim√©');
            loadSites(currentPage);
        }
    } catch (error) {
        console.error('Erreur:', error);
        alert('‚ùå Erreur lors de la suppression');
    }
}

// Charger au d√©marrage
document.addEventListener('DOMContentLoaded', () => {
    // Lire les param√®tres URL
    const params = new URLSearchParams(window.location.search);
    if (params.has('status')) document.getElementById('status-filter').value = params.get('status');
    if (params.has('has_email')) document.getElementById('email-filter').value = params.get('has_email');
    if (params.has('has_siret')) document.getElementById('siret-filter').value = params.get('has_siret');
    if (params.has('has_leaders')) document.getElementById('leaders-filter').value = params.get('has_leaders');

    applyFilters();
});
</script>
{% endblock %}
